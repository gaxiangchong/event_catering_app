{% extends "base.html" %}

{% block content %}
<div class="checkout-wrapper">
    <h2>Order Summary</h2>

    <div class="summary-card">
        <div class="summary-item">
            <span class="label">Event</span>
            <span class="value">{{ event.title }}</span>
        </div>
        <div class="summary-item">
            <span class="label">Date</span>
            <span class="value">{{ event.date.strftime('%B %d, %Y') }}</span>
        </div>
        <div class="summary-item">
            <span class="label">Location</span>
            <span class="value">{{ event.location }}</span>
        </div>
        <div class="summary-item">
            <span class="label">Meal Option</span>
            <span class="value highlight">{{ meal.name }}</span>
        </div>
        <hr>
        <div class="summary-item">
            <span class="label">Meal Fee</span>
            <span class="value">RM{{ "%.2f"|format(event.fee) }}</span>
        </div>
        <div class="summary-item">
            <span class="label">Meals Required</span>
            <span class="value">{{ meal_count }}</span>
        </div>
        <div class="summary-item">
            <span class="label">Meal Subtotal</span>
            <span class="value">RM{{ "%.2f"|format(base_amount) }}</span>
        </div>
        <div class="summary-item" id="stripe-fee-row">
            <span class="label">Stripe Fee (3% + RM1)</span>
            <span class="value">RM<span id="stripe-fee-value">{{ "%.2f"|format(stripe_fee) }}</span></span>
        </div>
        <hr>
        <div class="summary-item total">
            <span class="label" id="total-label">Estimated Total (Stripe)</span>
            <span class="value">RM<span id="total-value">{{ "%.2f"|format(stripe_total) }}</span></span>
        </div>
        <p id="summary-note" style="margin-top: 0.75rem; color: var(--text-muted); font-size: 0.9rem;">
            Stripe fee applies only to Stripe payments. Touch 'n Go has no admin fee.
        </p>
    </div>

    <form method="post" enctype="multipart/form-data" class="checkout-actions">
        <!-- Hidden inputs to carry over selection -->
        <input type="hidden" name="event_id" value="{{ event.id }}">
        <input type="hidden" name="meal_id" value="{{ meal.id }}">

        <h3 style="margin-top: 2rem;">Select Payment Method</h3>

        <div class="payment-methods">
            <label class="payment-method-card">
                <input type="radio" name="payment_method" value="stripe" checked onchange="togglePaymentFields()">
                <div class="payment-content">
                    <span class="material-symbols-rounded">credit_card</span>
                    <div>
                        <strong>Stripe</strong>
                        <p>Credit/Debit Card</p>
                    </div>
                </div>
            </label>

            <label class="payment-method-card">
                <input type="radio" name="payment_method" value="touchngo" onchange="togglePaymentFields()">
                <div class="payment-content">
                    <span class="material-symbols-rounded">phone_android</span>
                    <div>
                        <strong>Touch 'n Go</strong>
                        <p>Upload Payment Screenshot</p>
                    </div>
                </div>
            </label>
        </div>

        <!-- Touch n Go Upload Section -->
        <div id="touchngo-upload" style="display: none; margin-top: 1.5rem;">
            <div class="upload-instructions">
                <p><strong>Instructions:</strong></p>
                <ol>
                    <li>Make payment via Touch 'n Go app</li>
                    <li>Take a screenshot of the payment confirmation</li>
                    <li>Upload the screenshot below</li>
                    <li>Admin will verify and approve your payment</li>
                </ol>
            </div>

            <div class="form-group">
                <label>Touch 'n Go QR</label>
                <a href="{{ url_for('static', filename='QR_Payment.JPG') }}" download class="btn-secondary"
                    style="display: inline-flex; gap: 0.5rem; align-items: center;">
                    <span class="material-symbols-rounded">download</span>Download QR Payment
                </a>
                <!-- <small><br>Download the QR to use for payment transfer.</small> -->
            </div>

            <div class="form-group">
                <label for="payment_screenshot">Payment Screenshot</label>
                <input type="file" id="payment_screenshot" name="payment_screenshot"
                    accept="image/png,image/jpeg,image/jpg" class="file-input">
                <small>Accepted formats: PNG, JPG, JPEG (Max 5MB)</small>
            </div>
        </div>

        <div class="sticky-cta">
            <button type="submit" class="btn-primary">Confirm & Pay</button>
        </div>
        <div class="cancel-link-container">
            <a href="{{ url_for('events.get_event', event_id=event.id) }}" class="btn-text">Cancel</a>
        </div>
    </form>
</div>

<script>
    function togglePaymentFields() {
        const touchngoUpload = document.getElementById('touchngo-upload');
        const touchngoRadio = document.querySelector('input[value="touchngo"]');
        const fileInput = document.getElementById('payment_screenshot');
        const stripeFeeRow = document.getElementById('stripe-fee-row');
        const totalLabel = document.getElementById('total-label');
        const totalValue = document.getElementById('total-value');
        const summaryNote = document.getElementById('summary-note');

        const baseAmount = Number('{{ "%.2f"|format(base_amount) }}');
        const stripeFee = Number('{{ "%.2f"|format(stripe_fee) }}');
        const stripeTotal = Number('{{ "%.2f"|format(stripe_total) }}');

        if (touchngoRadio.checked) {
            touchngoUpload.style.display = 'block';
            fileInput.required = true;
            stripeFeeRow.style.display = 'none';
            totalLabel.textContent = 'Total Amount';
            totalValue.textContent = baseAmount.toFixed(2);
            summaryNote.textContent = "Touch 'n Go has no admin fee.";
        } else {
            touchngoUpload.style.display = 'none';
            fileInput.required = false;
            stripeFeeRow.style.display = '';
            totalLabel.textContent = 'Estimated Total (Stripe)';
            totalValue.textContent = stripeTotal.toFixed(2);
            summaryNote.textContent = "Stripe fee applies only to Stripe payments. Touch 'n Go has no admin fee.";
        }
    }

    // Initialize on page load
    togglePaymentFields();

</script>
{% endblock %}